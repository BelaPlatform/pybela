

<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../../">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>pybela.Logger &mdash; pybela 2.0.2 2.0.2 documentation</title>
      <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=80d5e7a1" />
      <link rel="stylesheet" type="text/css" href="../../_static/css/theme.css?v=e59714d7" />
      <link rel="stylesheet" type="text/css" href="../../_static/custom.css?v=b217d7a7" />

  
      <script src="../../_static/jquery.js?v=5d32c60e"></script>
      <script src="../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script src="../../_static/documentation_options.js?v=c2377ec0"></script>
      <script src="../../_static/doctools.js?v=9a2dae69"></script>
      <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../index.html" class="icon icon-home">
            pybela 2.0.2
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Getting started with pybela</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../readme.html">Installation and set up</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../readme.html#installing-the-python-package">1. Installing the python package</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../readme.html#set-the-bela-branch-to-dev">2. Set the Bela branch to <code class="docutils literal notranslate"><span class="pre">dev</span></code></a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../readme.html#option-a-bela-connected-to-internet">Option A: Bela connected to internet</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../readme.html#option-b-bela-not-connected-to-internet">Option B: Bela not connected to internet</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../readme.html#add-the-watcher-library-to-your-project">3. Add the watcher library to your project</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../readme.html#getting-started">Getting started</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../readme.html#modes-of-operation">Modes of operation</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../readme.html#running-the-tutorials">Running the tutorials</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../readme.html#basic-usage">Basic usage</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../readme.html#bela-side">Bela side</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../readme.html#python-side">Python side</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../readme.html#example-projects">Example projects</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../readme.html#testing">Testing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../readme.html#building">Building</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../readme.html#to-do-and-known-issues">To do and known issues</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../readme.html#license">License</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Module documentation</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../genindex.html">Index</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../modules.html"><code class="docutils literal notranslate"><span class="pre">Watcher</span></code></a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../modules.html#pybela.Watcher.Watcher.cleanup"><code class="docutils literal notranslate"><span class="pre">Watcher.cleanup()</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="../../modules.html#pybela.Watcher.Watcher.connect"><code class="docutils literal notranslate"><span class="pre">Watcher.connect()</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="../../modules.html#pybela.Watcher.Watcher.disconnect"><code class="docutils literal notranslate"><span class="pre">Watcher.disconnect()</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="../../modules.html#pybela.Watcher.Watcher.get_buffer_size"><code class="docutils literal notranslate"><span class="pre">Watcher.get_buffer_size()</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="../../modules.html#pybela.Watcher.Watcher.get_data_byte_size"><code class="docutils literal notranslate"><span class="pre">Watcher.get_data_byte_size()</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="../../modules.html#pybela.Watcher.Watcher.get_data_length"><code class="docutils literal notranslate"><span class="pre">Watcher.get_data_length()</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="../../modules.html#pybela.Watcher.Watcher.get_latest_timestamp"><code class="docutils literal notranslate"><span class="pre">Watcher.get_latest_timestamp()</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="../../modules.html#pybela.Watcher.Watcher.get_prop_of_var"><code class="docutils literal notranslate"><span class="pre">Watcher.get_prop_of_var()</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="../../modules.html#pybela.Watcher.Watcher.is_connected"><code class="docutils literal notranslate"><span class="pre">Watcher.is_connected()</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="../../modules.html#pybela.Watcher.Watcher.list"><code class="docutils literal notranslate"><span class="pre">Watcher.list()</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="../../modules.html#pybela.Watcher.Watcher.sample_rate"><code class="docutils literal notranslate"><span class="pre">Watcher.sample_rate</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="../../modules.html#pybela.Watcher.Watcher.send_ctrl_msg"><code class="docutils literal notranslate"><span class="pre">Watcher.send_ctrl_msg()</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="../../modules.html#pybela.Watcher.Watcher.unwatched_vars"><code class="docutils literal notranslate"><span class="pre">Watcher.unwatched_vars</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="../../modules.html#pybela.Watcher.Watcher.wait"><code class="docutils literal notranslate"><span class="pre">Watcher.wait()</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="../../modules.html#pybela.Watcher.Watcher.watched_vars"><code class="docutils literal notranslate"><span class="pre">Watcher.watched_vars</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="../../modules.html#pybela.Watcher.Watcher.watcher_vars"><code class="docutils literal notranslate"><span class="pre">Watcher.watcher_vars</span></code></a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../modules.html#pybela.Streamer.Streamer"><code class="docutils literal notranslate"><span class="pre">Streamer</span></code></a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../modules.html#pybela.Streamer.Streamer.async_stream_n_values"><code class="docutils literal notranslate"><span class="pre">Streamer.async_stream_n_values()</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="../../modules.html#pybela.Streamer.Streamer.is_streaming"><code class="docutils literal notranslate"><span class="pre">Streamer.is_streaming()</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="../../modules.html#pybela.Streamer.Streamer.load_data_from_file"><code class="docutils literal notranslate"><span class="pre">Streamer.load_data_from_file()</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="../../modules.html#pybela.Streamer.Streamer.monitored_vars"><code class="docutils literal notranslate"><span class="pre">Streamer.monitored_vars</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="../../modules.html#pybela.Streamer.Streamer.plot_data"><code class="docutils literal notranslate"><span class="pre">Streamer.plot_data()</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="../../modules.html#pybela.Streamer.Streamer.schedule_streaming"><code class="docutils literal notranslate"><span class="pre">Streamer.schedule_streaming()</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="../../modules.html#pybela.Streamer.Streamer.send_buffer"><code class="docutils literal notranslate"><span class="pre">Streamer.send_buffer()</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="../../modules.html#pybela.Streamer.Streamer.start_streaming"><code class="docutils literal notranslate"><span class="pre">Streamer.start_streaming()</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="../../modules.html#pybela.Streamer.Streamer.stop_streaming"><code class="docutils literal notranslate"><span class="pre">Streamer.stop_streaming()</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="../../modules.html#pybela.Streamer.Streamer.stream_n_values"><code class="docutils literal notranslate"><span class="pre">Streamer.stream_n_values()</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="../../modules.html#pybela.Streamer.Streamer.streaming_buffers_data"><code class="docutils literal notranslate"><span class="pre">Streamer.streaming_buffers_data</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="../../modules.html#pybela.Streamer.Streamer.streaming_buffers_queue"><code class="docutils literal notranslate"><span class="pre">Streamer.streaming_buffers_queue</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="../../modules.html#pybela.Streamer.Streamer.streaming_buffers_queue_length"><code class="docutils literal notranslate"><span class="pre">Streamer.streaming_buffers_queue_length</span></code></a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../modules.html#pybela.Logger.Logger"><code class="docutils literal notranslate"><span class="pre">Logger</span></code></a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../modules.html#pybela.Logger.Logger.connect_ssh"><code class="docutils literal notranslate"><span class="pre">Logger.connect_ssh()</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="../../modules.html#pybela.Logger.Logger.copy_all_bin_files_in_project"><code class="docutils literal notranslate"><span class="pre">Logger.copy_all_bin_files_in_project()</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="../../modules.html#pybela.Logger.Logger.copy_file_from_bela"><code class="docutils literal notranslate"><span class="pre">Logger.copy_file_from_bela()</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="../../modules.html#pybela.Logger.Logger.delete_all_bin_files_in_project"><code class="docutils literal notranslate"><span class="pre">Logger.delete_all_bin_files_in_project()</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="../../modules.html#pybela.Logger.Logger.delete_file_from_bela"><code class="docutils literal notranslate"><span class="pre">Logger.delete_file_from_bela()</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="../../modules.html#pybela.Logger.Logger.disconnect_ssh"><code class="docutils literal notranslate"><span class="pre">Logger.disconnect_ssh()</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="../../modules.html#pybela.Logger.Logger.finish_copying_file"><code class="docutils literal notranslate"><span class="pre">Logger.finish_copying_file()</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="../../modules.html#pybela.Logger.Logger.is_logging"><code class="docutils literal notranslate"><span class="pre">Logger.is_logging()</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="../../modules.html#pybela.Logger.Logger.read_binary_file"><code class="docutils literal notranslate"><span class="pre">Logger.read_binary_file()</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="../../modules.html#pybela.Logger.Logger.schedule_logging"><code class="docutils literal notranslate"><span class="pre">Logger.schedule_logging()</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="../../modules.html#pybela.Logger.Logger.start_logging"><code class="docutils literal notranslate"><span class="pre">Logger.start_logging()</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="../../modules.html#pybela.Logger.Logger.stop_logging"><code class="docutils literal notranslate"><span class="pre">Logger.stop_logging()</span></code></a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../modules.html#pybela.Monitor.Monitor"><code class="docutils literal notranslate"><span class="pre">Monitor</span></code></a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../modules.html#pybela.Monitor.Monitor.async_monitor_n_values"><code class="docutils literal notranslate"><span class="pre">Monitor.async_monitor_n_values()</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="../../modules.html#pybela.Monitor.Monitor.connect"><code class="docutils literal notranslate"><span class="pre">Monitor.connect()</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="../../modules.html#pybela.Monitor.Monitor.load_data_from_file"><code class="docutils literal notranslate"><span class="pre">Monitor.load_data_from_file()</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="../../modules.html#pybela.Monitor.Monitor.monitor_n_values"><code class="docutils literal notranslate"><span class="pre">Monitor.monitor_n_values()</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="../../modules.html#pybela.Monitor.Monitor.peek"><code class="docutils literal notranslate"><span class="pre">Monitor.peek()</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="../../modules.html#pybela.Monitor.Monitor.start_monitoring"><code class="docutils literal notranslate"><span class="pre">Monitor.start_monitoring()</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="../../modules.html#pybela.Monitor.Monitor.stop_monitoring"><code class="docutils literal notranslate"><span class="pre">Monitor.stop_monitoring()</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="../../modules.html#pybela.Monitor.Monitor.values"><code class="docutils literal notranslate"><span class="pre">Monitor.values</span></code></a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../modules.html#pybela.Controller.Controller"><code class="docutils literal notranslate"><span class="pre">Controller</span></code></a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../modules.html#pybela.Controller.Controller.get_controlled_status"><code class="docutils literal notranslate"><span class="pre">Controller.get_controlled_status()</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="../../modules.html#pybela.Controller.Controller.get_value"><code class="docutils literal notranslate"><span class="pre">Controller.get_value()</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="../../modules.html#pybela.Controller.Controller.send_value"><code class="docutils literal notranslate"><span class="pre">Controller.send_value()</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="../../modules.html#pybela.Controller.Controller.start_controlling"><code class="docutils literal notranslate"><span class="pre">Controller.start_controlling()</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="../../modules.html#pybela.Controller.Controller.stop_controlling"><code class="docutils literal notranslate"><span class="pre">Controller.stop_controlling()</span></code></a></li>
</ul>
</li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">pybela 2.0.2</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../index.html">Module code</a></li>
      <li class="breadcrumb-item active">pybela.Logger</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for pybela.Logger</h1><div class="highlight"><pre>
<span></span><span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">asyncio</span>
<span class="kn">import</span> <span class="nn">aiofiles</span>
<span class="kn">import</span> <span class="nn">struct</span>
<span class="kn">import</span> <span class="nn">paramiko</span>
<span class="kn">from</span> <span class="nn">.Watcher</span> <span class="kn">import</span> <span class="n">Watcher</span>
<span class="kn">from</span> <span class="nn">.utils</span> <span class="kn">import</span> <span class="n">_print_error</span><span class="p">,</span> <span class="n">_print_info</span><span class="p">,</span> <span class="n">_print_ok</span><span class="p">,</span> <span class="n">_print_warning</span>


<div class="viewcode-block" id="Logger">
<a class="viewcode-back" href="../../modules.html#pybela.Logger.Logger">[docs]</a>
<span class="k">class</span> <span class="nc">Logger</span><span class="p">(</span><span class="n">Watcher</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ip</span><span class="o">=</span><span class="s2">&quot;192.168.7.2&quot;</span><span class="p">,</span> <span class="n">port</span><span class="o">=</span><span class="mi">5555</span><span class="p">,</span> <span class="n">data_add</span><span class="o">=</span><span class="s2">&quot;gui_data&quot;</span><span class="p">,</span> <span class="n">control_add</span><span class="o">=</span><span class="s2">&quot;gui_control&quot;</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Logger class</span>

<span class="sd">            Args:</span>
<span class="sd">                ip (str, optional): Remote address IP. If using internet over USB, the IP won&#39;t work, pass &quot;bela.local&quot;. Defaults to &quot;192.168.7.2&quot;.</span>
<span class="sd">                port (int, optional): Remote address port. Defaults to 5555.</span>
<span class="sd">                data_add (str, optional): Data endpoint. Defaults to &quot;gui_data&quot;.</span>
<span class="sd">                control_add (str, optional): Control endpoint. Defaults to &quot;gui_control&quot;.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">Logger</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span> <span class="n">port</span><span class="p">,</span> <span class="n">data_add</span><span class="p">,</span> <span class="n">control_add</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_logging_mode</span> <span class="o">=</span> <span class="s2">&quot;OFF&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_logging_vars</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_logging_transfer</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">ssh_client</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sftp_client</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_active_copying_tasks</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_mode</span> <span class="o">=</span> <span class="s2">&quot;LOG&quot;</span>

    <span class="c1"># -- logging methods --</span>

<div class="viewcode-block" id="Logger.start_logging">
<a class="viewcode-back" href="../../modules.html#pybela.Logger.Logger.start_logging">[docs]</a>
    <span class="k">def</span> <span class="nf">start_logging</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">variables</span><span class="o">=</span><span class="p">[],</span> <span class="n">transfer</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">logging_dir</span><span class="o">=</span><span class="s2">&quot;./&quot;</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Starts logging session. The session can be ended by calling stop_logging().</span>

<span class="sd">        Args:</span>
<span class="sd">            variables (list of str, optional): List of variables to be logged. If no variables are passed, all variables in the watcher are logged. Defaults to [].</span>
<span class="sd">            transfer (bool, optional): If True, the logged files will be transferred automatically during the logging session. Defaults to False. #FIXME too slow</span>

<span class="sd">        Returns:</span>
<span class="sd">            list of str: List of local paths to the logged files.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">remote_paths</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">loop</span><span class="o">.</span><span class="n">run_until_complete</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__async_logging_common_routine</span><span class="p">(</span>
            <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;FOREVER&quot;</span><span class="p">,</span> <span class="n">timestamps</span><span class="o">=</span><span class="p">[],</span> <span class="n">durations</span><span class="o">=</span><span class="p">[],</span> <span class="n">variables</span><span class="o">=</span><span class="n">variables</span><span class="p">,</span> <span class="n">logging_dir</span><span class="o">=</span><span class="n">logging_dir</span><span class="p">))</span>

        <span class="n">local_paths</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">if</span> <span class="n">transfer</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">connect_ssh</span><span class="p">()</span>  <span class="c1"># start ssh connection</span>
            <span class="k">for</span> <span class="n">var</span> <span class="ow">in</span> <span class="p">[</span><span class="n">v</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">watcher_vars</span> <span class="k">if</span> <span class="n">v</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span> <span class="ow">in</span> <span class="n">variables</span><span class="p">]:</span>
                <span class="n">var</span> <span class="o">=</span> <span class="n">var</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span>
                <span class="n">local_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                    <span class="n">logging_dir</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">remote_paths</span><span class="p">[</span><span class="n">var</span><span class="p">]))</span>

                <span class="c1"># if file already exists, throw a warning and add number at the end of the filename</span>
                <span class="n">local_paths</span><span class="p">[</span><span class="n">var</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_generate_local_filename</span><span class="p">(</span>
                    <span class="n">local_path</span><span class="p">)</span>

                <span class="n">copying_task</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__copy_file_in_chunks</span><span class="p">(</span>
                    <span class="n">remote_paths</span><span class="p">[</span><span class="n">var</span><span class="p">],</span> <span class="n">local_paths</span><span class="p">[</span><span class="n">var</span><span class="p">])</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_active_copying_tasks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">copying_task</span><span class="p">)</span>

        <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;local_paths&quot;</span><span class="p">:</span> <span class="n">local_paths</span><span class="p">,</span> <span class="s2">&quot;remote_paths&quot;</span><span class="p">:</span> <span class="n">remote_paths</span><span class="p">}</span></div>


<div class="viewcode-block" id="Logger.schedule_logging">
<a class="viewcode-back" href="../../modules.html#pybela.Logger.Logger.schedule_logging">[docs]</a>
    <span class="k">def</span> <span class="nf">schedule_logging</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">variables</span><span class="o">=</span><span class="p">[],</span> <span class="n">timestamps</span><span class="o">=</span><span class="p">[],</span> <span class="n">durations</span><span class="o">=</span><span class="p">[],</span> <span class="n">transfer</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">logging_dir</span><span class="o">=</span><span class="s2">&quot;./&quot;</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Schedule logging session. The session starts at the specified timestamps and lasts for the specified durations. If the timestamp is in the past, the logging will start immediately. The session can be ended by calling stop_logging().</span>

<span class="sd">        Args:</span>
<span class="sd">            variables (list, optional): Variables to be logged. Defaults to [].</span>
<span class="sd">            timestamps (list, optional): Timestamps to start logging (one for each variable). Defaults to [].</span>
<span class="sd">            durations (list, optional): Durations to log for (one for each variable). Defaults to [].</span>
<span class="sd">            transfer (bool, optional): Transfer files to laptop automatically during logging session. Defaults to True.</span>
<span class="sd">            logging_dir (str, optional): Path to store the files. Defaults to &quot;./&quot;.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># check timestamps and duration types</span>
        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span>
            <span class="n">timestamps</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">all</span><span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">timestamp</span><span class="p">,</span> <span class="nb">int</span><span class="p">)</span> <span class="k">for</span> <span class="n">timestamp</span> <span class="ow">in</span> <span class="n">timestamps</span><span class="p">),</span> <span class="s2">&quot;Error: timestamps must be a list of ints.&quot;</span>
        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span>
            <span class="n">durations</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">all</span><span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">duration</span><span class="p">,</span> <span class="nb">int</span><span class="p">)</span> <span class="k">for</span> <span class="n">duration</span> <span class="ow">in</span> <span class="n">durations</span><span class="p">),</span> <span class="s2">&quot;Error: durations must be a list of ints.&quot;</span>

        <span class="n">remote_paths</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">loop</span><span class="o">.</span><span class="n">run_until_complete</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__async_logging_common_routine</span><span class="p">(</span>
            <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;SCHEDULED&quot;</span><span class="p">,</span> <span class="n">timestamps</span><span class="o">=</span><span class="n">timestamps</span><span class="p">,</span> <span class="n">durations</span><span class="o">=</span><span class="n">durations</span><span class="p">,</span> <span class="n">variables</span><span class="o">=</span><span class="n">variables</span><span class="p">,</span> <span class="n">logging_dir</span><span class="o">=</span><span class="n">logging_dir</span><span class="p">))</span>

        <span class="k">async</span> <span class="k">def</span> <span class="nf">_async_schedule_logging</span><span class="p">(</span><span class="n">variables</span><span class="p">,</span> <span class="n">timestamps</span><span class="p">,</span> <span class="n">durations</span><span class="p">,</span> <span class="n">transfer</span><span class="p">,</span> <span class="n">logging_dir</span><span class="p">):</span>
            <span class="c1"># checks types and if no variables are specified, stream all watcher variables (default)</span>
            <span class="n">latest_timestamp</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_async_get_latest_timestamp</span><span class="p">()</span>

            <span class="n">local_paths</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="k">if</span> <span class="n">transfer</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">connect_ssh</span><span class="p">()</span>  <span class="c1"># start ssh connection</span>

                <span class="k">async</span> <span class="k">def</span> <span class="nf">_async_check_if_file_exists_and_start_copying</span><span class="p">(</span><span class="n">var</span><span class="p">,</span> <span class="n">timestamp</span><span class="p">):</span>

                    <span class="n">diff_stamps</span> <span class="o">=</span> <span class="n">timestamp</span> <span class="o">-</span> <span class="n">latest_timestamp</span>
                    <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
                        <span class="n">_has_file_been_created</span> <span class="o">=</span> <span class="mi">0</span>

                        <span class="n">remote_file_size</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sftp_client</span><span class="o">.</span><span class="n">stat</span><span class="p">(</span>
                            <span class="n">remote_paths</span><span class="p">[</span><span class="n">var</span><span class="p">])</span><span class="o">.</span><span class="n">st_size</span>

                        <span class="k">if</span> <span class="n">remote_file_size</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>  <span class="c1"># white till first buffers are written into the file</span>
                            <span class="n">_has_file_been_created</span> <span class="o">=</span> <span class="mi">1</span>
                            <span class="n">_print_info</span><span class="p">(</span>
                                <span class="sa">f</span><span class="s2">&quot;Logging started for </span><span class="si">{</span><span class="n">var</span><span class="si">}</span><span class="s2">...&quot;</span><span class="p">)</span>
                            <span class="k">break</span>  <span class="c1"># Break the loop if the remote file size is non-zero</span>

                        <span class="k">if</span> <span class="n">_has_file_been_created</span><span class="p">:</span>
                            <span class="k">break</span>

                        <span class="c1"># Wait before checking again</span>
                        <span class="k">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="n">diff_stamps</span><span class="o">//</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">sample_rate</span><span class="p">))</span>

                    <span class="c1"># when file has been created</span>
                    <span class="n">local_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                        <span class="n">logging_dir</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">remote_paths</span><span class="p">[</span><span class="n">var</span><span class="p">]))</span>

                    <span class="c1"># if file already exists, throw a warning and add number at the end of the filename</span>
                    <span class="n">local_paths</span><span class="p">[</span><span class="n">var</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_generate_local_filename</span><span class="p">(</span>
                        <span class="n">local_path</span><span class="p">)</span>

                    <span class="n">copying_task</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__copy_file_in_chunks</span><span class="p">(</span>
                        <span class="n">remote_paths</span><span class="p">[</span><span class="n">var</span><span class="p">],</span> <span class="n">local_paths</span><span class="p">[</span><span class="n">var</span><span class="p">])</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_active_copying_tasks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">copying_task</span><span class="p">)</span>

                <span class="n">_active_checking_tasks</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">var</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">variables</span><span class="p">):</span>
                    <span class="n">check_task</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">loop</span><span class="o">.</span><span class="n">create_task</span><span class="p">(</span>
                        <span class="n">_async_check_if_file_exists_and_start_copying</span><span class="p">(</span><span class="n">var</span><span class="p">,</span> <span class="n">timestamps</span><span class="p">[</span><span class="n">idx</span><span class="p">]))</span>
                    <span class="n">_active_checking_tasks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">check_task</span><span class="p">)</span>

                <span class="c1"># wait for the longest duration</span>
                <span class="k">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="n">durations</span><span class="p">)</span><span class="o">//</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sample_rate</span><span class="p">))</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_logging_mode</span> <span class="o">=</span> <span class="s2">&quot;OFF&quot;</span>

                <span class="c1"># wait for all the files to be created</span>
                <span class="k">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">gather</span><span class="p">(</span><span class="o">*</span><span class="n">_active_checking_tasks</span><span class="p">,</span> <span class="n">return_exceptions</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="c1"># wait for all the files to be copied</span>
                <span class="k">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">gather</span><span class="p">(</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">_active_copying_tasks</span><span class="p">,</span> <span class="n">return_exceptions</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_active_copying_tasks</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
                <span class="n">_active_checking_tasks</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">sftp_client</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">disconnect_ssh</span><span class="p">()</span>

                <span class="c1"># async version (non blocking)</span>
                <span class="c1"># async def _async_cleanup():</span>
                <span class="c1">#     await asyncio.gather(*self._active_copying_tasks, return_exceptions=True)</span>
                <span class="c1">#     self._active_copying_tasks.clear()</span>
                <span class="c1">#     self.sftp_client.close()</span>
                <span class="c1"># asyncio.run(_async_cleanup())</span>

            <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;local_paths&quot;</span><span class="p">:</span> <span class="n">local_paths</span><span class="p">,</span> <span class="s2">&quot;remote_paths&quot;</span><span class="p">:</span> <span class="n">remote_paths</span><span class="p">}</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">loop</span><span class="o">.</span><span class="n">run_until_complete</span><span class="p">(</span><span class="n">_async_schedule_logging</span><span class="p">(</span><span class="n">variables</span><span class="o">=</span><span class="n">variables</span><span class="p">,</span> <span class="n">timestamps</span><span class="o">=</span><span class="n">timestamps</span><span class="p">,</span> <span class="n">durations</span><span class="o">=</span><span class="n">durations</span><span class="p">,</span> <span class="n">transfer</span><span class="o">=</span><span class="n">transfer</span><span class="p">,</span> <span class="n">logging_dir</span><span class="o">=</span><span class="n">logging_dir</span><span class="p">))</span></div>


    <span class="k">async</span> <span class="k">def</span> <span class="nf">__async_logging_common_routine</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mode</span><span class="p">,</span> <span class="n">timestamps</span><span class="o">=</span><span class="p">[],</span> <span class="n">durations</span><span class="o">=</span><span class="p">[],</span> <span class="n">variables</span><span class="o">=</span><span class="p">[],</span> <span class="n">logging_dir</span><span class="o">=</span><span class="s2">&quot;./&quot;</span><span class="p">):</span>
        <span class="c1"># checks types and if no variables are specified, stream all watcher variables (default)</span>
        <span class="n">variables</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_var_arg_checker</span><span class="p">(</span><span class="n">variables</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">logging_dir</span><span class="p">):</span>
            <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">logging_dir</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_logging</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">loop</span><span class="o">.</span><span class="n">create_task</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_async_stop_logging</span><span class="p">())</span>

        <span class="c1"># self.connect_ssh()  # start ssh connection</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_logging_mode</span> <span class="o">=</span> <span class="n">mode</span>

        <span class="n">remote_files</span><span class="p">,</span> <span class="n">remote_paths</span> <span class="o">=</span> <span class="p">{},</span> <span class="p">{}</span>

        <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_async_send_ctrl_msg</span><span class="p">({</span><span class="s2">&quot;watcher&quot;</span><span class="p">:</span> <span class="p">[</span>
            <span class="p">{</span><span class="s2">&quot;cmd&quot;</span><span class="p">:</span> <span class="s2">&quot;log&quot;</span><span class="p">,</span> <span class="s2">&quot;timestamps&quot;</span><span class="p">:</span> <span class="n">timestamps</span><span class="p">,</span> <span class="s2">&quot;durations&quot;</span><span class="p">:</span> <span class="n">durations</span><span class="p">,</span> <span class="s2">&quot;watchers&quot;</span><span class="p">:</span> <span class="n">variables</span><span class="p">}]})</span>

        <span class="n">_list</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_async_list</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">var</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">variables</span><span class="p">):</span>
            <span class="n">remote_files</span><span class="p">[</span><span class="n">var</span><span class="p">]</span> <span class="o">=</span> <span class="n">_list</span><span class="p">[</span><span class="s2">&quot;watchers&quot;</span><span class="p">][</span><span class="n">idx</span><span class="p">][</span><span class="s2">&quot;logFileName&quot;</span><span class="p">]</span>
            <span class="n">remote_paths</span><span class="p">[</span><span class="n">var</span><span class="p">]</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;/root/Bela/projects/</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">project_name</span><span class="si">}</span><span class="s1">/</span><span class="si">{</span><span class="n">remote_files</span><span class="p">[</span><span class="n">var</span><span class="p">]</span><span class="si">}</span><span class="s1">&#39;</span>

        <span class="n">_print_info</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Started logging variables </span><span class="si">{</span><span class="n">variables</span><span class="si">}</span><span class="s2">... Run stop_logging() to stop logging.&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">remote_paths</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">_async_stop_logging</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">variables</span><span class="o">=</span><span class="p">[]):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Stops logging session.</span>

<span class="sd">        Args:</span>
<span class="sd">            variables (list of str, optional): List of variables to stop logging. If none is passed, logging is stopped for all variables in the watcher. Defaults to [].</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_logging_mode</span> <span class="o">=</span> <span class="s2">&quot;OFF&quot;</span>
        <span class="k">if</span> <span class="n">variables</span> <span class="o">==</span> <span class="p">[]:</span>
            <span class="c1"># if no variables specified, stop streaming all watcher variables (default)</span>
            <span class="n">variables</span> <span class="o">=</span> <span class="p">[</span><span class="n">var</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">var</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">watcher_vars</span><span class="p">]</span>

        <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_async_send_ctrl_msg</span><span class="p">(</span>
            <span class="p">{</span><span class="s2">&quot;watcher&quot;</span><span class="p">:</span> <span class="p">[{</span><span class="s2">&quot;cmd&quot;</span><span class="p">:</span> <span class="s2">&quot;unlog&quot;</span><span class="p">,</span> <span class="s2">&quot;watchers&quot;</span><span class="p">:</span> <span class="n">variables</span><span class="p">}]})</span>

        <span class="n">_print_info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Stopped logging variables </span><span class="si">{</span><span class="n">variables</span><span class="si">}</span><span class="s2">...&quot;</span><span class="p">)</span>

        <span class="k">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">gather</span><span class="p">(</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">_active_copying_tasks</span><span class="p">,</span> <span class="n">return_exceptions</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_active_copying_tasks</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">sftp_client</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">disconnect_ssh</span><span class="p">()</span>

<div class="viewcode-block" id="Logger.stop_logging">
<a class="viewcode-back" href="../../modules.html#pybela.Logger.Logger.stop_logging">[docs]</a>
    <span class="k">def</span> <span class="nf">stop_logging</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">variables</span><span class="o">=</span><span class="p">[]):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Stops logging session. Sync wrapper for _async_stop_logging().</span>

<span class="sd">        Args:</span>
<span class="sd">            variables (list of str, optional): List of variables to stop logging. If none is passed, logging is stopped for all variables in the watcher. Defaults to [].</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">loop</span><span class="o">.</span><span class="n">run_until_complete</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_async_stop_logging</span><span class="p">(</span><span class="n">variables</span><span class="p">))</span></div>


    <span class="c1"># -- binary file parsing method</span>

<div class="viewcode-block" id="Logger.read_binary_file">
<a class="viewcode-back" href="../../modules.html#pybela.Logger.Logger.read_binary_file">[docs]</a>
    <span class="k">def</span> <span class="nf">read_binary_file</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">file_path</span><span class="p">,</span> <span class="n">timestamp_mode</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Reads a binary file generated by the logger and returns a dictionary with the file contents.</span>

<span class="sd">        Args:</span>
<span class="sd">            file_path (str): Path of the file to be read.</span>
<span class="sd">            timestamp_mode (str): Timestamp mode of the variable. Can be &quot;dense&quot; or &quot;sparse&quot;.</span>

<span class="sd">        Returns:</span>
<span class="sd">            dict: Dictionary with the file contents.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">file_path</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">_print_error</span><span class="p">(</span><span class="s2">&quot;Error: No file path provided.&quot;</span><span class="p">)</span>
            <span class="k">return</span>
        <span class="n">file_size</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">getsize</span><span class="p">(</span><span class="n">file_path</span><span class="p">)</span>
        <span class="k">assert</span> <span class="n">file_size</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;Error: The size of </span><span class="si">{</span><span class="n">file_path</span><span class="si">}</span><span class="s2"> is 0.&quot;</span>

        <span class="k">def</span> <span class="nf">_parse_null_terminated_string</span><span class="p">(</span><span class="n">file</span><span class="p">):</span>
            <span class="n">result</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
            <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
                <span class="n">char</span> <span class="o">=</span> <span class="n">file</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">char</span> <span class="o">==</span> <span class="s1">&#39;</span><span class="se">\0</span><span class="s1">&#39;</span><span class="p">:</span>
                    <span class="k">break</span>
                <span class="n">result</span> <span class="o">+=</span> <span class="n">char</span>
            <span class="k">return</span> <span class="n">result</span>

        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">file_path</span><span class="p">,</span> <span class="s2">&quot;rb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">file</span><span class="p">:</span>

            <span class="c1"># parse header</span>
            <span class="n">name</span> <span class="o">=</span> <span class="n">_parse_null_terminated_string</span><span class="p">(</span><span class="n">file</span><span class="p">)</span>
            <span class="n">var_name</span> <span class="o">=</span> <span class="n">_parse_null_terminated_string</span><span class="p">(</span><span class="n">file</span><span class="p">)</span>
            <span class="n">_type</span> <span class="o">=</span> <span class="n">_parse_null_terminated_string</span><span class="p">(</span><span class="n">file</span><span class="p">)</span>
            <span class="n">pid</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span><span class="s2">&quot;I&quot;</span><span class="p">,</span> <span class="n">file</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">struct</span><span class="o">.</span><span class="n">calcsize</span><span class="p">(</span><span class="s2">&quot;I&quot;</span><span class="p">)))[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">pid_id</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span><span class="s2">&quot;I&quot;</span><span class="p">,</span> <span class="n">file</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">struct</span><span class="o">.</span><span class="n">calcsize</span><span class="p">(</span><span class="s2">&quot;I&quot;</span><span class="p">)))[</span><span class="mi">0</span><span class="p">]</span>

            <span class="c1"># if header size is not a multiple of 4, we need to add padding</span>
            <span class="n">header_size</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">name</span><span class="p">)</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="n">var_name</span><span class="p">)</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="n">_type</span><span class="p">)</span> <span class="o">+</span> \
                <span class="mi">3</span> <span class="o">+</span> <span class="n">struct</span><span class="o">.</span><span class="n">calcsize</span><span class="p">(</span><span class="s2">&quot;I&quot;</span><span class="p">)</span> <span class="o">+</span> <span class="n">struct</span><span class="o">.</span><span class="n">calcsize</span><span class="p">(</span><span class="s2">&quot;I&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">header_size</span> <span class="o">%</span> <span class="mi">4</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">file</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="mi">4</span> <span class="o">-</span> <span class="n">header_size</span> <span class="o">%</span> <span class="mi">4</span><span class="p">)</span>  <span class="c1"># padding</span>

            <span class="n">_parse_type</span> <span class="o">=</span> <span class="s1">&#39;i&#39;</span> <span class="k">if</span> <span class="n">_type</span> <span class="o">==</span> <span class="s1">&#39;j&#39;</span> <span class="k">else</span> <span class="n">_type</span>  <span class="c1"># struct does not understand &#39;j&#39;</span>

            <span class="c1"># parse data buffers</span>
            <span class="n">parsed_buffers</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
                <span class="c1"># Read file buffer by buffer</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">data</span> <span class="o">=</span> <span class="n">file</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_buffer_size</span><span class="p">(</span>
                        <span class="n">_parse_type</span><span class="p">,</span> <span class="n">timestamp_mode</span><span class="p">))</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="k">break</span>  <span class="c1"># No more data to read</span>
                    <span class="n">_parsed_buffer</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parse_binary_data</span><span class="p">(</span>
                        <span class="n">data</span><span class="p">,</span> <span class="n">timestamp_mode</span><span class="p">,</span> <span class="n">_parse_type</span><span class="p">)</span>
                    <span class="n">parsed_buffers</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">_parsed_buffer</span><span class="p">)</span>

                <span class="k">except</span> <span class="n">struct</span><span class="o">.</span><span class="n">error</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="n">_print_error</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>
                    <span class="k">break</span>  <span class="c1"># No more data to read</span>

        <span class="k">return</span> <span class="p">{</span>
            <span class="s2">&quot;project_name&quot;</span><span class="p">:</span> <span class="n">name</span><span class="p">,</span>
            <span class="s2">&quot;var_name&quot;</span><span class="p">:</span> <span class="n">var_name</span><span class="p">,</span>
            <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="n">_type</span><span class="p">,</span>
            <span class="c1"># &quot;pid&quot;: pid,</span>
            <span class="c1"># &quot;pid_id&quot;: pid_id,</span>
            <span class="s2">&quot;buffers&quot;</span><span class="p">:</span> <span class="n">parsed_buffers</span>
        <span class="p">}</span></div>


    <span class="c1"># -- ssh methods &amp; utils --</span>

<div class="viewcode-block" id="Logger.connect_ssh">
<a class="viewcode-back" href="../../modules.html#pybela.Logger.Logger.connect_ssh">[docs]</a>
    <span class="k">def</span> <span class="nf">connect_ssh</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Connects to Bela via ssh to transfer log files.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">sftp_client</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">disconnect_ssh</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">ssh_client</span> <span class="o">=</span> <span class="n">paramiko</span><span class="o">.</span><span class="n">SSHClient</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ssh_client</span><span class="o">.</span><span class="n">set_missing_host_key_policy</span><span class="p">(</span><span class="n">paramiko</span><span class="o">.</span><span class="n">AutoAddPolicy</span><span class="p">())</span>

        <span class="c1"># Workaround for no authentication:</span>
        <span class="c1"># https://github.com/paramiko/paramiko/issues/890#issuecomment-906893725</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ssh_client</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">ip</span><span class="p">,</span> <span class="n">port</span><span class="o">=</span><span class="mi">22</span><span class="p">,</span> <span class="n">username</span><span class="o">=</span><span class="s2">&quot;root&quot;</span><span class="p">,</span> <span class="n">password</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">paramiko</span><span class="o">.</span><span class="n">SSHException</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ssh_client</span><span class="o">.</span><span class="n">get_transport</span><span class="p">()</span><span class="o">.</span><span class="n">auth_none</span><span class="p">(</span><span class="s2">&quot;root&quot;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">_print_error</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Error while connecting to Bela via ssh: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">bcolors</span><span class="o">.</span><span class="n">ENDC</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">return</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sftp_client</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ssh_client</span><span class="o">.</span><span class="n">open_sftp</span><span class="p">()</span>
            <span class="c1"># _print_ok(&quot;SSH connection and SFTP client established successfully.&quot;)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">_print_error</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Error while opening SFTP client: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">bcolors</span><span class="o">.</span><span class="n">ENDC</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">disconnect_ssh</span><span class="p">()</span></div>


<div class="viewcode-block" id="Logger.disconnect_ssh">
<a class="viewcode-back" href="../../modules.html#pybela.Logger.Logger.disconnect_ssh">[docs]</a>
    <span class="k">def</span> <span class="nf">disconnect_ssh</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Disconnects from Bela via ssh.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">sftp_client</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sftp_client</span><span class="o">.</span><span class="n">close</span><span class="p">()</span></div>


<div class="viewcode-block" id="Logger.is_logging">
<a class="viewcode-back" href="../../modules.html#pybela.Logger.Logger.is_logging">[docs]</a>
    <span class="k">def</span> <span class="nf">is_logging</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Returns True if the logger is currently logging, false otherwise.</span>

<span class="sd">        Returns:</span>
<span class="sd">            bool: Logger status</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="kc">True</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_logging_mode</span> <span class="o">!=</span> <span class="s2">&quot;OFF&quot;</span> <span class="k">else</span> <span class="kc">False</span></div>


    <span class="k">def</span> <span class="nf">__copy_file_in_chunks</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">remote_path</span><span class="p">,</span> <span class="n">local_path</span><span class="p">,</span>  <span class="n">chunk_size</span><span class="o">=</span><span class="mi">2</span><span class="o">**</span><span class="mi">12</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Copies a file from the remote path to the local path in chunks. This function is called by start_logging() if transfer=True.</span>

<span class="sd">        Args:</span>
<span class="sd">            remote_path (str): Path to the file in Bela.</span>
<span class="sd">            local_path (str): Path to the file in the local machine (where the file is copied to)</span>
<span class="sd">            chunk_size (int, optional): Chunk size. Defaults to 2**12.</span>

<span class="sd">        Returns:</span>
<span class="sd">            asyncio.Task: Task that copies the file in chunks.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">async</span> <span class="k">def</span> <span class="nf">async_copy_file_in_chunks</span><span class="p">(</span><span class="n">remote_path</span><span class="p">,</span> <span class="n">local_path</span><span class="p">,</span> <span class="n">chunk_size</span><span class="o">=</span><span class="mi">2</span><span class="o">**</span><span class="mi">12</span><span class="p">):</span>

            <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
                <span class="c1"># Wait for a second before checking again</span>
                <span class="k">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>  <span class="c1"># TODO can this be lower?</span>

                <span class="k">try</span><span class="p">:</span>
                    <span class="n">remote_file</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sftp_client</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">remote_path</span><span class="p">,</span> <span class="s1">&#39;rb&#39;</span><span class="p">)</span>
                    <span class="n">remote_file_size</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sftp_client</span><span class="o">.</span><span class="n">stat</span><span class="p">(</span>
                        <span class="n">remote_path</span><span class="p">)</span><span class="o">.</span><span class="n">st_size</span>

                    <span class="k">if</span> <span class="n">remote_file_size</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>  <span class="c1"># white till first buffers are written into the file</span>
                        <span class="k">break</span>  <span class="c1"># Break the loop if the remote file size is non-zero</span>

                <span class="k">except</span> <span class="ne">FileNotFoundError</span><span class="p">:</span>
                    <span class="n">_print_error</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;Remote file &#39;</span><span class="si">{</span><span class="n">remote_path</span><span class="si">}</span><span class="s2">&#39; does not exist.&quot;</span><span class="p">)</span>
                    <span class="k">return</span> <span class="kc">None</span>

            <span class="k">try</span><span class="p">:</span>
                <span class="k">async</span> <span class="k">with</span> <span class="n">aiofiles</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">local_path</span><span class="p">,</span> <span class="s1">&#39;wb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">local_file</span><span class="p">:</span>
                    <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
                        <span class="n">chunk</span> <span class="o">=</span> <span class="n">remote_file</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">chunk_size</span><span class="p">)</span>
                        <span class="c1"># keep checking file whilst logging is still going on (in case a variable fills the buffers slowly)</span>
                        <span class="k">if</span> <span class="ow">not</span> <span class="n">chunk</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_logging_mode</span> <span class="o">==</span> <span class="s2">&quot;OFF&quot;</span><span class="p">:</span>
                            <span class="k">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.1</span><span class="p">)</span>  <span class="c1"># flushed data</span>
                            <span class="k">break</span>
                        <span class="k">await</span> <span class="n">local_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">chunk</span><span class="p">)</span>
                        <span class="n">_print_ok</span><span class="p">(</span>
                            <span class="sa">f</span><span class="s2">&quot;</span><span class="se">\r</span><span class="s2">Transferring </span><span class="si">{</span><span class="n">remote_path</span><span class="si">}</span><span class="s2">--&gt;</span><span class="si">{</span><span class="n">local_path</span><span class="si">}</span><span class="s2">...&quot;</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                        <span class="k">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.1</span><span class="p">)</span>
                    <span class="n">chunk</span> <span class="o">=</span> <span class="n">remote_file</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
                    <span class="k">if</span> <span class="n">chunk</span><span class="p">:</span>
                        <span class="k">await</span> <span class="n">local_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">chunk</span><span class="p">)</span>
                    <span class="n">remote_file</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
                    <span class="n">_print_ok</span><span class="p">(</span><span class="s2">&quot;Done.&quot;</span><span class="p">)</span>

            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="n">_print_error</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Error while transferring file: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>
                <span class="k">return</span> <span class="kc">None</span>

            <span class="k">finally</span><span class="p">:</span>
                <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_async_remove_item_from_list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_active_copying_tasks</span><span class="p">,</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">current_task</span><span class="p">())</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">loop</span><span class="o">.</span><span class="n">create_task</span><span class="p">(</span><span class="n">async_copy_file_in_chunks</span><span class="p">(</span><span class="n">remote_path</span><span class="p">,</span> <span class="n">local_path</span><span class="p">,</span> <span class="n">chunk_size</span><span class="p">))</span>

<div class="viewcode-block" id="Logger.copy_file_from_bela">
<a class="viewcode-back" href="../../modules.html#pybela.Logger.Logger.copy_file_from_bela">[docs]</a>
    <span class="k">def</span> <span class="nf">copy_file_from_bela</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">remote_path</span><span class="p">,</span> <span class="n">local_path</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Copy a file from Bela onto the local machine.</span>

<span class="sd">        Args:</span>
<span class="sd">            remote_path (str): Path to the remote file to be copied.</span>
<span class="sd">            local_path (str): Path to the local file (where the file is copied to)</span>
<span class="sd">            verbose (bool, optional): Show info messages. Defaults to True.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">connect_ssh</span><span class="p">()</span>
        <span class="n">local_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">loop</span><span class="o">.</span><span class="n">run_until_complete</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_async_copy_file_from_bela</span><span class="p">(</span>
            <span class="n">remote_path</span><span class="p">,</span> <span class="n">local_path</span><span class="p">,</span> <span class="n">verbose</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">disconnect_ssh</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">local_path</span></div>


<div class="viewcode-block" id="Logger.copy_all_bin_files_in_project">
<a class="viewcode-back" href="../../modules.html#pybela.Logger.Logger.copy_all_bin_files_in_project">[docs]</a>
    <span class="k">def</span> <span class="nf">copy_all_bin_files_in_project</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">dir</span><span class="o">=</span><span class="s2">&quot;./&quot;</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Copies all .bin files in the specified remote directory using SFTP.</span>

<span class="sd">        Args:</span>
<span class="sd">            dir (str, optional): Path to the local directory where the files are copied to. Defaults to &quot;./&quot;.</span>
<span class="sd">            verbose (bool, optional): Show info messages. Defaults to True.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">remote_path</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;/root/Bela/projects/</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">project_name</span><span class="si">}</span><span class="s1">&#39;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">connect_ssh</span><span class="p">()</span>
            <span class="n">copy_tasks</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_action_on_all_bin_files_in_project</span><span class="p">(</span>
                <span class="s2">&quot;copy&quot;</span><span class="p">,</span> <span class="nb">dir</span><span class="p">)</span>

            <span class="c1"># wait until all files are copied</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">loop</span><span class="o">.</span><span class="n">run_until_complete</span><span class="p">(</span><span class="n">asyncio</span><span class="o">.</span><span class="n">gather</span><span class="p">(</span>
                <span class="o">*</span><span class="n">copy_tasks</span><span class="p">,</span> <span class="n">return_exceptions</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span>

            <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                <span class="n">_print_ok</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;All .bin files in </span><span class="si">{</span><span class="n">remote_path</span><span class="si">}</span><span class="s2"> have been copied to </span><span class="si">{</span><span class="nb">dir</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">_print_error</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Error copying .bin files in </span><span class="si">{</span><span class="n">remote_path</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">disconnect_ssh</span><span class="p">()</span></div>


    <span class="k">async</span> <span class="k">def</span> <span class="nf">_async_copy_file_from_bela</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">remote_path</span><span class="p">,</span> <span class="n">local_path</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Copies a file from the remote path in Bela to the local path. This can be used any time to copy files from Bela to the host. </span>

<span class="sd">        Args:</span>
<span class="sd">            remote_path (str): Path to the file in Bela.</span>
<span class="sd">            local_path (str): Path to the file in the local machine (where the file is copied to)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">_local_path</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">local_path</span><span class="p">):</span>
                <span class="n">_local_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_generate_local_filename</span><span class="p">(</span><span class="n">local_path</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">_local_path</span> <span class="o">=</span> <span class="n">local_path</span>
            <span class="n">transferred_event</span> <span class="o">=</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">Event</span><span class="p">()</span>
            <span class="k">def</span> <span class="nf">callback</span><span class="p">(</span><span class="n">transferred</span><span class="p">,</span> <span class="n">to_transfer</span><span class="p">):</span> <span class="k">return</span> <span class="n">transferred_event</span><span class="o">.</span><span class="n">set</span><span class="p">(</span>
            <span class="p">)</span> <span class="k">if</span> <span class="n">transferred</span> <span class="o">==</span> <span class="n">to_transfer</span> <span class="k">else</span> <span class="kc">None</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sftp_client</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">remote_path</span><span class="p">,</span> <span class="n">_local_path</span><span class="p">,</span> <span class="n">callback</span><span class="o">=</span><span class="n">callback</span><span class="p">)</span>
            <span class="n">file_size</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sftp_client</span><span class="o">.</span><span class="n">stat</span><span class="p">(</span><span class="n">remote_path</span><span class="p">)</span><span class="o">.</span><span class="n">st_size</span>
            <span class="k">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">wait_for</span><span class="p">(</span><span class="n">transferred_event</span><span class="o">.</span><span class="n">wait</span><span class="p">(),</span> <span class="n">timeout</span><span class="o">=</span><span class="n">file_size</span><span class="o">*</span><span class="mf">1e-4</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                <span class="n">_print_ok</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;</span><span class="se">\r</span><span class="s2">Transferring </span><span class="si">{</span><span class="n">remote_path</span><span class="si">}</span><span class="s2">--&gt;</span><span class="si">{</span><span class="n">_local_path</span><span class="si">}</span><span class="s2">... Done.&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">local_path</span>
        <span class="k">except</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">exceptions</span><span class="o">.</span><span class="n">TimeoutError</span><span class="p">:</span>
            <span class="n">_print_error</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Error while transferring file: TimeoutError.&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">_print_error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error while transferring file: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">None</span>

<div class="viewcode-block" id="Logger.finish_copying_file">
<a class="viewcode-back" href="../../modules.html#pybela.Logger.Logger.finish_copying_file">[docs]</a>
    <span class="k">def</span> <span class="nf">finish_copying_file</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">remote_path</span><span class="p">,</span> <span class="n">local_path</span><span class="p">):</span>  <span class="c1"># TODO test</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Finish copying file if it was interrupted. This function is used to copy the remaining part of a file that was interrupted during the copy process.</span>

<span class="sd">        Args:</span>
<span class="sd">           remote_path (str): Path to the file in Bela.</span>
<span class="sd">            local_path (str): Path to the file in the local machine (where the file is copied to)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">connect_ssh</span><span class="p">()</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">remote_file</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sftp_client</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">remote_path</span><span class="p">,</span> <span class="s1">&#39;rb&#39;</span><span class="p">)</span>
            <span class="n">remote_file_size</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sftp_client</span><span class="o">.</span><span class="n">stat</span><span class="p">(</span>
                <span class="n">remote_path</span><span class="p">)</span><span class="o">.</span><span class="n">st_size</span>
        <span class="k">except</span> <span class="ne">FileNotFoundError</span><span class="p">:</span>
            <span class="n">_print_error</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Remote file &#39;</span><span class="si">{</span><span class="n">remote_path</span><span class="si">}</span><span class="s2">&#39; does not exist.&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">disconnect_ssh</span><span class="p">()</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">local_path</span><span class="p">):</span>
            <span class="n">_print_error</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Local file &#39;</span><span class="si">{</span><span class="n">local_path</span><span class="si">}</span><span class="s2">&#39; does not exist. If you want to copy a file that hasn&#39;t been partially copied yet, use copy_file_from_bela() instead.&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">disconnect_ssh</span><span class="p">()</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="n">local_file_size</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">getsize</span><span class="p">(</span><span class="n">local_path</span><span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">local_file_size</span> <span class="o">&lt;</span> <span class="n">remote_file_size</span><span class="p">:</span>
                <span class="c1"># Calculate the remaining part to copy</span>
                <span class="n">remaining_size</span> <span class="o">=</span> <span class="n">remote_file_size</span> <span class="o">-</span> <span class="n">local_file_size</span>
                <span class="c1"># Use readv to read the remaining part of the file</span>
                <span class="n">chunks</span> <span class="o">=</span> <span class="p">[(</span><span class="n">local_file_size</span><span class="p">,</span> <span class="n">remaining_size</span><span class="p">)]</span>
                <span class="n">data</span> <span class="o">=</span> <span class="n">remote_file</span><span class="o">.</span><span class="n">readv</span><span class="p">(</span><span class="n">chunks</span><span class="p">)</span>

                <span class="n">_print_ok</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;</span><span class="se">\r</span><span class="s2">Transferring </span><span class="si">{</span><span class="n">remote_path</span><span class="si">}</span><span class="s2">--&gt;</span><span class="si">{</span><span class="n">local_path</span><span class="si">}</span><span class="s2">...&quot;</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="c1"># Append the data to the local file</span>
                <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">local_path</span><span class="p">,</span> <span class="s1">&#39;ab&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">local_file</span><span class="p">:</span>
                    <span class="n">local_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
                <span class="n">_print_ok</span><span class="p">(</span><span class="s2">&quot;Done.&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">_print_error</span><span class="p">(</span>
                    <span class="s2">&quot;Local file is already up-to-date or larger than the remote file.&quot;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">_print_error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error finishing file copy: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">disconnect_ssh</span><span class="p">()</span></div>


<div class="viewcode-block" id="Logger.delete_file_from_bela">
<a class="viewcode-back" href="../../modules.html#pybela.Logger.Logger.delete_file_from_bela">[docs]</a>
    <span class="k">def</span> <span class="nf">delete_file_from_bela</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">remote_path</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Deletes a file from the remote path in Bela.</span>

<span class="sd">        Args:</span>
<span class="sd">            remote_path (str): Path to the remote file to be deleted. </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">connect_ssh</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">loop</span><span class="o">.</span><span class="n">run_until_complete</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_async_delete_file_from_bela</span><span class="p">(</span><span class="n">remote_path</span><span class="p">,</span> <span class="n">verbose</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">disconnect_ssh</span><span class="p">()</span></div>


<div class="viewcode-block" id="Logger.delete_all_bin_files_in_project">
<a class="viewcode-back" href="../../modules.html#pybela.Logger.Logger.delete_all_bin_files_in_project">[docs]</a>
    <span class="k">def</span> <span class="nf">delete_all_bin_files_in_project</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Deletes all .bin files in the specified remote directory using SFTP.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">remote_path</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;/root/Bela/projects/</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">project_name</span><span class="si">}</span><span class="s1">&#39;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">connect_ssh</span><span class="p">()</span>
            <span class="n">deletion_tasks</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_action_on_all_bin_files_in_project</span><span class="p">(</span>
                <span class="s2">&quot;delete&quot;</span><span class="p">)</span>

            <span class="c1"># wait until all files are deleted</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">loop</span><span class="o">.</span><span class="n">run_until_complete</span><span class="p">(</span><span class="n">asyncio</span><span class="o">.</span><span class="n">gather</span><span class="p">(</span>
                <span class="o">*</span><span class="n">deletion_tasks</span><span class="p">,</span> <span class="n">return_exceptions</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span>

            <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                <span class="n">_print_ok</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;All .bin files in </span><span class="si">{</span><span class="n">remote_path</span><span class="si">}</span><span class="s2"> have been removed.&quot;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">_print_error</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Error deleting .bin files in </span><span class="si">{</span><span class="n">remote_path</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">disconnect_ssh</span><span class="p">()</span></div>


    <span class="k">async</span> <span class="k">def</span> <span class="nf">_async_delete_file_from_bela</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">remote_path</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="c1"># this function doesn&#39;t return until the file has been deleted</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sftp_client</span><span class="o">.</span><span class="n">stat</span><span class="p">(</span><span class="n">remote_path</span><span class="p">)</span>  <span class="c1"># check if file exists</span>
        <span class="k">except</span> <span class="ne">FileNotFoundError</span><span class="p">:</span>
            <span class="n">_print_error</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Error: Remote file &#39;</span><span class="si">{</span><span class="n">remote_path</span><span class="si">}</span><span class="s2">&#39; does not exist.&quot;</span><span class="p">)</span>
            <span class="k">return</span>

        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
            <span class="k">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.1</span><span class="p">)</span>  <span class="c1"># Adjust the interval as needed</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="c1"># Attempt to remove the file</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">sftp_client</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">remote_path</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">FileNotFoundError</span><span class="p">:</span>
                <span class="c1"># File does not exist, it has been successfully removed</span>
                <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                    <span class="n">_print_ok</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;File &#39;</span><span class="si">{</span><span class="n">remote_path</span><span class="si">}</span><span class="s2">&#39; has been removed from Bela.&quot;</span><span class="p">)</span>
                <span class="k">break</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="n">_print_error</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Error while deleting file in Bela: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2"> &quot;</span><span class="p">)</span>
                <span class="k">break</span>

    <span class="k">def</span> <span class="nf">_action_on_all_bin_files_in_project</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">action</span><span class="p">,</span> <span class="n">local_dir</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="c1"># List all files in the remote directory</span>
        <span class="n">remote_path</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;/root/Bela/projects/</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">project_name</span><span class="si">}</span><span class="s1">&#39;</span>
        <span class="n">file_list</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sftp_client</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">remote_path</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">file_list</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">_print_warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;No .bin files in </span><span class="si">{</span><span class="n">remote_path</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>
            <span class="k">return</span>

        <span class="c1"># Iterate through the files and delete .bin files</span>
        <span class="n">tasks</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">for</span> <span class="n">file_name</span> <span class="ow">in</span> <span class="n">file_list</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">file_name</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;.bin&#39;</span><span class="p">):</span>
                <span class="n">remote_file_path</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">remote_path</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">file_name</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="k">if</span> <span class="n">action</span> <span class="o">==</span> <span class="s2">&quot;delete&quot;</span><span class="p">:</span>
                    <span class="n">task</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">loop</span><span class="o">.</span><span class="n">create_task</span><span class="p">(</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_async_delete_file_from_bela</span><span class="p">(</span><span class="n">remote_file_path</span><span class="p">))</span>
                <span class="k">elif</span> <span class="n">action</span> <span class="o">==</span> <span class="s2">&quot;copy&quot;</span><span class="p">:</span>
                    <span class="n">local_filename</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">local_dir</span><span class="p">,</span> <span class="n">file_name</span><span class="p">)</span>
                    <span class="n">task</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">loop</span><span class="o">.</span><span class="n">create_task</span><span class="p">(</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_async_copy_file_from_bela</span><span class="p">(</span><span class="n">remote_file_path</span><span class="p">,</span> <span class="n">local_filename</span><span class="p">))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Invalid action: </span><span class="si">{</span><span class="n">action</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">tasks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">task</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">tasks</span>

    <span class="k">def</span> <span class="fm">__del__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__del__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">disconnect_ssh</span><span class="p">()</span>  <span class="c1"># disconnect ssh</span></div>

</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2024.</p>
  </div>

   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>